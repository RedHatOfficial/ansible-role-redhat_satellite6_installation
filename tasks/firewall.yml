---
- name: "Include firewall.yml"
  include_vars: "vars/firewall.yml"
  tags:
    - "firewall"

#Install firewalld and enable it
- name: "Install firewalld"
  become: "yes"
  yum:
    name: "firewalld"
    state: "present"
  ignore_errors: "yes"
  tags:
    - "firewall"

- name: "Set hostname with hostnamectl"
  hostname:
    name: "{{ satellite_deployment_hostname_full }}"
  tags:
    - "firewall"

- name: "Ensure required ansible facts are set"
  assert:
    that:
      - ansible_fqdn is defined and ansible_fqdn.find("localhost") == -1
      - ansible_hostname is defined and ansible_hostname.find("localhost") == -1
    msg: "Hostname must be set"

- name: "Update /etc/hosts with satellite hostname"
  lineinfile:
    line: "{{ ansible_default_ipv4.address }}
      {{ ansible_fqdn }}
      {{ ansible_hostname }}"
    dest: "/etc/hosts"
  tags:
    - "firewall"

- name: "Enable Firewalld"
  become: "yes"
  service:
    enabled: "yes"
    name: "firewalld"
    state: "started"
  tags:
    - "firewall"

#Opening firewall ports
- name: "Firewall and hostname | Opening Firewalld ports"
  become: "yes"
  firewalld:
    permanent: "yes"
    immediate: "yes"
    port: "{{ item }}"
    state: "enabled"
  with_items: "{{ satellite_deployment_fw_ports }}"
  ignore_errors: "yes"
  tags:
    - "firewall"
